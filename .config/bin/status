#! /bin/sh

run()
{
  "$@" && return 0
  code=$?
  echo 2>&1 "command \`$@' failed with exit status $code"
  exit $code
}

run cd "$(dirname "$(readlink -e "$0")")"/../..
run git config --file=.gitmodules --list | sed -n 's/^submodule\.\([^".]\+\)\.path=\([^"]\+\)$/name="\1" path="\2"/p' |
while read line
do
  run eval "$line"
  run git --no-pager status --short "$path"
  if [ -r "$path" ]
  then
    run git --no-pager diff --submodule=log "$path"
  fi
done
run git --no-pager status --short --untracked-files=no --ignore-submodules=all

